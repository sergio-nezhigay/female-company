{% comment %}
  Even though we already parse the colors inside section.liquid snippet,
  we need it again here because of JS color transitions.
{% endcomment %}
{%- liquid 
  if section.settings.section_background_color == 'rgba(0,0,0,0)'
    assign section_background = settings.background
  else
    assign section_background = section.settings.section_background_color
  endif

  if section.settings.section_text_color == 'rgba(0,0,0,0)'
    assign text_color = settings.text_color
  else
    assign text_color = section.settings.section_text_color
  endif
-%}

{%- render 'section' -%}
<div class="layer-technology">
  {%- render 'section-header' -%}

  <div class="layer-technology__layers">
    {%- for block in section.blocks -%}
      <div class="layer-technology__layer layer layer-{{ forloop.index0 }}" id="block-{{ block.id }}" data-border-color="{{ block.settings.layer_border_color }}" data-background-color="{{ block.settings.layer_background_color }}" data-text-color="{{ block.settings.layer_text_color }}" {{ block.shopify_attributes }}>
        <style>
          #block-{{ block.id }} {
            {%- unless block.settings.layer_subheading_color == 'rgba(0,0,0,0)' -%}
              --subheading-color: {{ block.settings.layer_subheading_color.red }}, {{ block.settings.layer_subheading_color.green }}, {{ block.settings.layer_subheading_color.blue }};
            {%- endunless -%}
          }
        </style>
        <div class="layer-technology__layer-image" style="border-color: {{ block.settings.layer_border_color }};">
          {{ block.settings.image | image_url: width: 150, height: 150, crop: 'center' | image_tag }}
        </div>
        <div class="layer-technology__layer-content">
          <h6 class="layer-technology__layer-subtitle heading heading--small">{{ block.settings.subheading }}</h2>
          <h5 class="layer-technology__layer-title heading h6">{{ block.settings.title }}</h2>
          <div class="layer-technology__layer-description text--small">
            {{ block.settings.description }}
          </div>
        </div>
      </div>
    {%- endfor -%}
  </div>
</div>
{%- render 'section-end' -%}

{% stylesheet %}
.layer-technology__layers {
  position: relative;
}

.layer-technology__layer {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
  position: relative;
}

.layer-technology__layer.layer-0 {
  z-index: 4;
}

.layer-technology__layer.layer-1 {
  z-index: 3;
}

.layer-technology__layer.layer-2 {
  z-index: 2;
}

.layer-technology__layer.layer-3 {
  z-index: 1;
}

.layer-technology__layer-image {
  width: 120px;
  height: 150px;
  box-shadow: 25px 25px 100px rgba(0, 0, 0, 0.2);
  margin-right: 16px;
  border: 3px solid transparent;
  flex-shrink: 0;
}

.layer-technology__layer-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.layer-technology__layer-content {
  flex: 1;
}

.layer-technology__layer-title {
  margin-bottom: 4px;
  margin-top: 0!important;
}

.layer-technology__layer-subtitle {
  margin-bottom: 4px;
}

@media only screen and (min-width: 741px) {
  .layer-technology__layers {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);
    gap: 16px;
  }
}
{% endstylesheet %}

<script defer src="{{ 'gsap.min.js' | asset_url }}"></script>
<script defer src="{{ 'gsap.ScrollTrigger.min.js' | asset_url }}"></script>
<script type="text/javascript">
  (function() {
    const reducedMotionQuery = window.matchMedia("(prefers-reduced-motion: reduce)");
    const viewportQuery = window.matchMedia("(min-width: 741px)");

    // Disable for reduced motion devices
    if (!reducedMotionQuery || reducedMotionQuery.matches) {
      return;
    }

    // Disable for desktop due to 95% mobile access
    if (!viewportQuery || viewportQuery.matches) {
      return;
    }

    window.addEventListener('DOMContentLoaded', function () {
      const sectionId = '#shopify-section-{{ section.id }}';
      const layer0 = document.querySelector(sectionId + ' .layer-0');
      const layer1 = document.querySelector(sectionId + ' .layer-1');
      const layer2 = document.querySelector(sectionId + ' .layer-2');
      const layer3 = document.querySelector(sectionId + ' .layer-3');
  
      const baseOffset = 100;
  
      const prevPrevPrevOffset = 0;
      const prevPrevOffset = 0;
      const prevOffset = 0;
      const currentOffset = 0;
      const nextOffset = 20;
      const nextNextOffset = 5;
  
      const baseRotate = 40;
      const baseSkewX = -20;
      const baseSkewY = -10;
      const baseImageBorderWidth = 3;
      const baseImageWidth = 120;
      const baseImageHeight = 120;
  
      const highlightRotate = 0;
      const hightlightSkewX = 0;
      const hightlightSkewY = 0;
      const highlightImageBorderWidth = 3;
      const highlightImageWidth = 120;
      const highlightImageHeight = 150;
      const highlightImageMargin = 16;
  
      const sectionBg = "{{ section_background }}";
      const sectionTextColor = "{{ text_color }}";

      const sectionHeaderHeight = document.querySelector(sectionId + ' .section__header').offsetHeight;
  
      const layerStyling = {
        0: {
          backgroundColor: layer0.dataset.backgroundColor === 'rgba(0,0,0,0)' ? sectionBg : layer0.dataset.backgroundColor,
          borderColor: layer0.dataset.borderColor,
          textColor: layer0.dataset.textColor === 'rgba(0,0,0,0)' ? textColor : layer0.dataset.textColor,
        },
        1: {
          backgroundColor: layer1.dataset.backgroundColor === 'rgba(0,0,0,0)' ? sectionBg : layer1.dataset.backgroundColor,
          borderColor: layer1.dataset.borderColor,
          textColor: layer1.dataset.textColor === 'rgba(0,0,0,0)' ? textColor : layer1.dataset.textColor,
        },
        2: {
          backgroundColor: layer2.dataset.backgroundColor === 'rgba(0,0,0,0)' ? sectionBg : layer2.dataset.backgroundColor,
          borderColor: layer2.dataset.borderColor,
          textColor: layer2.dataset.textColor === 'rgba(0,0,0,0)' ? textColor : layer2.dataset.textColor,
        },
        3: {
          backgroundColor: layer3.dataset.backgroundColor === 'rgba(0,0,0,0)' ? sectionBg : layer3.dataset.backgroundColor,
          borderColor: layer3.dataset.borderColor,
          textColor: layer3.dataset.textColor === 'rgba(0,0,0,0)' ? textColor : layer3.dataset.textColor,
        },
      };
  
      let currentLayer;

      console.log("sectionId", sectionId);
  
      // Create timeline
      const tl = gsap
        .timeline({
          scrollTrigger: {
            trigger: sectionId,
            start: 'top top',
            end: `+=${Math.max(2000, window.innerHeight * 4)}`,
            scrub: 0.5,
            pin: true,
            snap: {
              snapTo: "labelsDirectional",
              duration: {min: 0.2, max: 0.7},
              delay: 0,
              ease: "power1.inOut"
            }
          },
        });
  
      /**
        * INITIALIZE STYLES
        */
      tl.addLabel("init");
      tl.set(sectionId, { minHeight: "100vh" });
      tl.set(`${sectionId} .section`, { height: "100%", overflow: "hidden" });
      tl.set(".layer-technology__layer", { rotate: baseRotate, skewX: baseSkewX, skewY: baseSkewY, justifyContent: "center" });
      tl.set(".layer-technology__layer-image", { marginRight: 0, borderWidth: baseImageBorderWidth });
      tl.set(".layer-technology__layer-content", { overflow: "hidden", width: 0, height: 0, opacity: 0, display: "flex", flexDirection: "column", justifyContent: "center", flex: "initial" });
      tl.set(".layer-0", { opacity: 0.9, yPercent: 0, zIndex: 4 });
      tl.set(".layer-1", { opacity: 0.7, yPercent: -100, zIndex: 3 });
      tl.set(".layer-2", { opacity: 0.5, yPercent: -200, zIndex: 2 });
      tl.set(".layer-3", { opacity: 0.3, yPercent: -300, zIndex: 1 });
      tl.set(".layer-0 .layer-technology__layer-image", { borderColor: layerStyling[0].borderColor, width: baseImageWidth, height: baseImageHeight });
      tl.set(".layer-1 .layer-technology__layer-image", { borderColor: layerStyling[1].borderColor, width: baseImageWidth, height: baseImageHeight });
      tl.set(".layer-2 .layer-technology__layer-image", { borderColor: layerStyling[2].borderColor, width: baseImageWidth, height: baseImageHeight });
      tl.set(".layer-3 .layer-technology__layer-image", { borderColor: layerStyling[3].borderColor, width: baseImageWidth, height: baseImageHeight });
  
      /**
        * Scene: Initialize position
        */
      tl.addLabel("scene-start:init-position");
      // Hide navbar
      tl.to("#shopify-section-header", { yPercent: -100 });
      tl.to("#mobile-facet-toolbar", { opacity: 0, yPercent: -200 }, "<");
  
      /**
        * Scene: Highlight layer 0
        */
      tl.addLabel("scene-start:layer0");
  
      // VARIABLES
      currentLayer = 0;
        
      // SUBSCENE 1
      // Transition background color
      tl.to(`${sectionId} .section`, { backgroundColor: layerStyling[currentLayer].backgroundColor }, "<50%");
      // Transition text color
      tl.to(`${sectionId} .section .section__header .heading, ${sectionId} .section .section__header-short-description`, { color: layerStyling[currentLayer].textColor }, "<");
      tl.to(".layer-technology__layer-title, .layer-technology__layer-description", { color: layerStyling[currentLayer].textColor }, "<");
      // Position layers & highlight current layer
      tl.to(".layer-0", { opacity: 1, yPercent: 0 - currentOffset, rotate: highlightRotate, skewX: hightlightSkewX, skewY: hightlightSkewY }, "<");
      tl.to(".layer-1", { opacity: 0.7, yPercent: 50 - nextOffset }, "<");
      tl.to(".layer-2", { opacity: 0.5, yPercent: -50 - nextNextOffset }, "<");
      tl.to(".layer-3", { opacity: 0.3, yPercent: -150 }, "<");
      // Remove image border
      tl.to(`.layer-${currentLayer} .layer-technology__layer-image`, { borderWidth: highlightImageBorderWidth, width: highlightImageWidth, height: highlightImageHeight }, "<");
        
      // SUBSCENE 2
      // Add placeholder for layer content
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { width: "auto", height: highlightImageHeight }, "<25%");
      // Add image margin
      tl.to(`.layer-${currentLayer} .layer-technology__layer-image`, { marginRight: highlightImageMargin }, "<");
  
      // SUBSCENE 3
      // Show layer content
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { opacity: 1 });
  
      // SUBSCENE 4
      // Duplicate previous animation to insert pause
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { opacity: 1 });
  
      /**
        * Scene: Highlight layer 1
        */
      tl.addLabel("scene-start:layer1");
  
      // VARIABLES
      currentLayer = 1;
        
      // SUBSCENE 1
      // Transition background color
      tl.to(`${sectionId} .section`, { backgroundColor: layerStyling[currentLayer].backgroundColor });
      // Transition text color
      tl.to(`${sectionId} .section .section__header .heading, ${sectionId} .section .section__header-short-description`, { color: layerStyling[currentLayer].textColor }, "<");
      tl.to(".layer-technology__layer-title, .layer-technology__layer-description", { color: layerStyling[currentLayer].textColor }, "<");
      // Position layers & highlight current layer
      tl.to(".layer-1", { opacity: 1, yPercent: 0 - currentOffset, rotate: highlightRotate, skewX: hightlightSkewX, skewY: hightlightSkewY }, "<");
      tl.to(".layer-2", { opacity: 0.7, yPercent: 50 - nextOffset }, "<");
      tl.to(".layer-3", { opacity: 0.5, yPercent: -50 - nextNextOffset }, "<");
      // Remove image border
      tl.to(`.layer-${currentLayer} .layer-technology__layer-image`, { borderWidth: highlightImageBorderWidth, width: highlightImageWidth, height: highlightImageHeight }, "<");
      // Scroll up header
      tl.to(`${sectionId} .section__header`, { marginTop: -((sectionHeaderHeight / 3) * 1), opacity: 0.66, marginBottom: 22 }, "<");
        
      // SUBSCENE 2
      // Add placeholder for layer content
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { width: "auto", height: highlightImageHeight }, "<25%");
      // Add image margin
      tl.to(`.layer-${currentLayer} .layer-technology__layer-image`, { marginRight: highlightImageMargin }, "<");
  
      // SUBSCENE 3
      // Show layer content
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { opacity: 1 });
  
      // SUBSCENE 4
      // Duplicate previous animation to insert pause
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { opacity: 1 });
  
      /**
        * Scene: Highlight layer 2
        */
      tl.addLabel("scene-start:layer2");
  
      // VARIABLES
      currentLayer = 2;
        
      // SUBSCENE 1
      // Transition background color
      tl.to(`${sectionId} .section`, { backgroundColor: layerStyling[currentLayer].backgroundColor });
      // Transition text color
      tl.to(`${sectionId} .section .section__header .heading, ${sectionId} .section .section__header-short-description`, { color: layerStyling[currentLayer].textColor }, "<");
      tl.to(".layer-technology__layer-title, .layer-technology__layer-description", { color: layerStyling[currentLayer].textColor }, "<");
      // Position layers & highlight current layer
      tl.to(".layer-2", { opacity: 1, yPercent: 0 - currentOffset, rotate: highlightRotate, skewX: hightlightSkewX, skewY: hightlightSkewY }, "<");
      tl.to(".layer-3", { opacity: 0.7, yPercent: 50 - nextOffset }, "<");
      // Remove image border
      tl.to(`.layer-${currentLayer} .layer-technology__layer-image`, { borderWidth: highlightImageBorderWidth, width: highlightImageWidth, height: highlightImageHeight }, "<");
      // Scroll up header
      tl.to(`${sectionId} .section__header`, { marginTop: -((sectionHeaderHeight / 3) * 2), opacity: 0.33, marginBottom: 12 }, "<");
        
      // SUBSCENE 2
      // Add placeholder for layer content
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { width: "auto", height: highlightImageHeight }, "<25%");
      // Add image margin
      tl.to(`.layer-${currentLayer} .layer-technology__layer-image`, { marginRight: highlightImageMargin }, "<");
  
      // SUBSCENE 3
      // Show layer content
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { opacity: 1 });
        
      // SUBSCENE 4
      // Duplicate previous animation to insert pause
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { opacity: 1 });
        
      /**
        * Scene: Highlight layer 3
        */
      tl.addLabel("scene-start:layer3");
  
      // VARIABLES
      currentLayer = 3;
        
      // SUBSCENE 1
      // Transition background color
      tl.to(`${sectionId} .section`, { backgroundColor: layerStyling[currentLayer].backgroundColor });
      // Transition text color
      tl.to(`${sectionId} .section .section__header .heading, ${sectionId} .section .section__header-short-description`, { color: layerStyling[currentLayer].textColor }, "<");
      tl.to(".layer-technology__layer-title, .layer-technology__layer-description", { color: layerStyling[currentLayer].textColor }, "<");
      // Position layers & highlight current layer
      tl.to(".layer-3", { opacity: 1, yPercent: 0 - currentOffset, rotate: highlightRotate, skewX: hightlightSkewX, skewY: hightlightSkewY }, "<");
      // Remove image border
      tl.to(`.layer-${currentLayer} .layer-technology__layer-image`, { borderWidth: highlightImageBorderWidth, width: highlightImageWidth, height: highlightImageHeight }, "<");
      // Scroll up header
      tl.to(`${sectionId} .section__header`, { marginTop: -((sectionHeaderHeight / 3) * 3), opacity: 0, marginBottom: 0 }, "<");
        
      // SUBSCENE 2
      // Add placeholder for layer content
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { width: "auto", height: highlightImageHeight }, "<25%");
      // Add image margin
      tl.to(`.layer-${currentLayer} .layer-technology__layer-image`, { marginRight: highlightImageMargin }, "<");
  
      // SUBSCENE 3
      // Show layer content
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { opacity: 1 });
  
      // SUBSCENE 4
      // Duplicate previous animation to insert pause
      tl.to(`.layer-${currentLayer} .layer-technology__layer-content`, { opacity: 1 });
  
  
      /**
        * Scene: End
        */
      tl.addLabel("scene-start:end");
  
      // SUBSCENE 1
      // Transition background color
      tl.to(`${sectionId} .section`, { backgroundColor: sectionBg });
      // Transition text color
      tl.to(`${sectionId} .section .section__header .heading, ${sectionId} .section .section__header-short-description`, { color: sectionTextColor }, "<");
      tl.to(".layer-technology__layer-title, .layer-technology__layer-description", { color: sectionTextColor }, "<");
      // Show navbar
      tl.to("#shopify-section-header", { yPercent: 0 }, "<");
      tl.to("#mobile-facet-toolbar", { opacity: 1, yPercent: 0 }, "<");
        
      // Reenable overflow
      tl.set(`${sectionId} .section`, { height: "100%", overflow: "visible" });
  
      /**
        * END
        */
      tl.addLabel("end");
    });
  })();
</script>

{% schema %}
{
  "name": "Layer Technology",
  "tag": "section",
  "max_blocks": 4,
  "blocks": [
    {
      "name": "Layer",
      "type": "layer",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "subheading",
          "label": "Subheading",
          "default": "Your layer subheading"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Your layer title"
        },
        {
          "type": "richtext",
          "id": "description",
          "label": "Description",
          "default": "<p>Your layer description</p>"
        },
        {
          "type": "color",
          "id": "layer_background_color",
          "label": "Background color",
          "default": "rgba(0,0,0,0)"
        },
        {
          "type": "color",
          "id": "layer_border_color",
          "label": "Border color",
          "default": "#ffffff"
        },
        {
          "type": "color",
          "id": "layer_subheading_color",
          "label": "Subheading color",
          "default": "rgba(0,0,0,0)"
        },
        {
          "type": "color",
          "id": "layer_text_color",
          "label": "Text color",
          "default": "#1a1a1a"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Section header"
    },
    {
      "type": "textarea",
      "id": "section_header_subheading",
      "label": "Subheading",
      "default": "Subheading"
    },
    {
      "type": "textarea",
      "id": "section_header_heading",
      "label": "Heading",
      "default": "Heading"
    },
    {
      "type": "richtext",
      "id": "section_header_short_description",
      "label": "Short description",
      "default": "<p>Your short description.</p>"
    },
    {
      "type": "select",
      "id": "section_header_heading_size",
      "label": "Heading size",
      "options": [
        {
          "value": "h1",
          "label": "Heading 1"
        },
        {
          "value": "h2",
          "label": "Heading 2"
        },
        {
          "value": "h3",
          "label": "Heading 3"
        },
        {
          "value": "h4",
          "label": "Heading 4"
        },
        {
          "value": "h5",
          "label": "Heading 5"
        },
        {
          "value": "h6",
          "label": "Heading 6"
        }
      ],
      "default": "h3"
    },
    {
      "type": "checkbox",
      "id": "section_header_highest_hierarchy",
      "label": "Highest hierarchy",
      "info": "Check this if this is the highest hierarchy heading on the page. This will make this a 'h1' heading, which should only be used once per page.",
      "default": false
    },
    {
      "type": "select",
      "id": "section_header_short_description_font_size",
      "label": "Short description font size",
      "options": [
        {
          "value": "xxsmall",
          "label": "Extra extra Small"
        },
        {
          "value": "xsmall",
          "label": "Extra Small"
        },
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ],
      "default": "medium"
    },
    {
      "type": "header",
      "content": "Section settings"
    },
    {
      "type": "select",
      "id": "section_container_width",
      "label": "Maximum width",
      "options": [
        {
          "value": "xxs",
          "label": "Extra extra Small"
        },
        {
          "value": "xs",
          "label": "Extra Small"
        },
        {
          "value": "sm",
          "label": "Small"
        },
        {
          "value": "md",
          "label": "Medium"
        },
        {
          "value": "fluid",
          "label": "Full width"
        }
      ],
      "default": "md"
    },
    {
      "type": "color",
      "id": "section_background_color",
      "label": "Background color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "color",
      "id": "section_text_color",
      "label": "Text color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "color",
      "id": "section_heading_color",
      "label": "Heading color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "color",
      "id": "section_subheading_color",
      "label": "Subheading color",
      "default": "rgba(0,0,0,0)",
      "info": "Defaults to heading color."
    },
    {
      "type": "select",
      "id": "section_heading_font_family",
      "label": "Heading font",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "circular",
          "label": "Circular"
        },
        {
          "value": "publico",
          "label": "Publico"
        }
      ],
      "default": "default"
    },
    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "range",
      "id": "section_spacing_top",
      "label": "Top spacing",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 32
    },
    {
      "type": "range",
      "id": "section_spacing_bottom",
      "label": "Bottom spacing",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 32
    },
    {
      "type": "checkbox",
      "id": "section_spacing_different_mobile",
      "label": "Use different height on mobile",
      "default": false
    },
    {
      "type": "range",
      "id": "section_spacing_top_mobile",
      "label": "Top spacing (mobile)",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0
    },
    {
      "type": "range",
      "id": "section_spacing_bottom_mobile",
      "label": "Bottom spacing (mobile)",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Layer Technology",
      "blocks": [
        {
          "type": "layer"
        },
        {
          "type": "layer"
        },
        {
          "type": "layer"
        },
        {
          "type": "layer"
        }
      ]
    }
  ]
}
{% endschema %}
