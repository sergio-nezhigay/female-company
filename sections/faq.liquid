{%- liquid 
  assign section_background = background_color | default: section.settings.section_background_color
  if section_background == 'rgba(0,0,0,0)' or section_background == blank
    assign section_background = settings.background
  endif
   
  assign text_color = text_color | default: section.settings.section_text_color
  if text_color == 'rgba(0,0,0,0)' or text_color == blank
    assign text_color = settings.text_color
  endif
-%}

<style>
  #shopify-section-{{ section.id }} {
    {%- if section_background == settings.background -%}
      {%- assign secondary_background = settings.secondary_background -%}
    {%- else -%}
      {%- assign secondary_background = section_background | color_mix: text_color, 85 -%}
    {%- endif -%}

    --secondary-background: {{ secondary_background.red }}, {{ secondary_background.green }}, {{ secondary_background.blue }};
  }
</style>

{%- assign categories = section.blocks | where: 'type', 'category' -%}
{%- assign category_titles = '' -%}
{%- assign category_ids = '' -%}

{%- for block in section.blocks -%}
  {%- case block.type -%}
    {%- when 'category' -%}
      {%- assign category_titles = category_titles | append: block.settings.title | append: '###'  -%}
      {%- assign category_ids = category_ids | append: block.id | append: '###' %}

    {%- when 'faq_collection' -%}
      {%- if block.settings.metaobject_handle != blank -%}
        {%- assign faq_collection = shop.metaobjects["faq_collection"][block.settings.metaobject_handle] -%}

        {%- if faq_collection != blank -%}
          {%- if block.settings.show_title and faq_collection.title.value != blank -%}
            {%- assign category_titles = category_titles | append: faq_collection.title.value | append: '###'  -%}
            {%- assign category_ids = category_ids | append: block.id | append: '###' %}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}
  {%- endcase -%}
{%- endfor -%}

{%- assign category_titles = category_titles | remove_last: '###' | split: '###' -%}
{%- assign category_ids = category_ids | remove_last: '###' | split: '###' -%}

{%- render 'section' -%}
  {%- render 'section-header' -%}

  <div class="faq">
    {%- if section.settings.show_navigation and category_titles.size > 0 -%}
      <div class="faq-navigation hidden-pocket">
        <scroll-spy class="scroll-spy">
          <ul class="scroll-spy__list list--unstyled">
            {%- for category_title in category_titles -%}
              {%- assign category_id = category_ids[forloop.index0] -%}
              <li class="scroll-spy__item">
                <a class="scroll-spy__anchor heading heading--small" href="#category-{{ section.id }}-{{ category_id }}" data-smooth-scroll>{{ category_title | escape }}</a>
              </li>
            {%- endfor -%}
          </ul>
        </scroll-spy>
      </div>
    {%- endif -%}

    <div class="faq__wrapper">
      {%- for block in section.blocks -%}
        {%- case block.type -%}
          {%- when 'category' -%}
            <h2 id="category-{{ section.id }}-{{ block.id }}" class="faq__category heading h6 anchor" {{ block.shopify_attributes }}>
              {{- block.settings.title |  escape -}}
            </h2>

          {%- when 'question' -%}
            <div class="faq__item">
              <button is="toggle-button" class="collapsible-toggle text--strong" aria-controls="block-{{ section.id }}-{{ block.id }}" aria-expanded="false">
                {{- block.settings.title -}}
                <span class="animated-plus"></span>
              </button>

              <collapsible-content id="block-{{ section.id }}-{{ block.id }}" class="collapsible anchor" {{ block.shopify_attributes }}>
                <div class="collapsible__content text-container">
                  {{ block.settings.answer }}
                </div>
              </collapsible-content>
            </div>

          {%- when 'faq_collection' -%}
            {%- if block.settings.metaobject_handle != blank -%}
              {%- assign faq_collection = shop.metaobjects["faq_collection"][block.settings.metaobject_handle] -%}

              {%- if faq_collection != blank -%}
                {%- if block.settings.show_title and faq_collection.title.value != blank -%}
                  <h2 id="category-{{ section.id }}-{{ block.id }}" class="faq__category heading h6 anchor">
                    {{- faq_collection.title.value |  escape -}}
                  </h2>
                {%- endif -%}
      
                {%- for faq in faq_collection.faqs.value -%}

                  {%- if faq.question.value == blank or faq.response.value == blank -%}
                    {%- continue -%}
                  {%- endif -%}

                  <div class="faq__item">
                    <button is="toggle-button" class="collapsible-toggle text--strong" aria-controls="block-{{ section.id }}-{{ block.id }}-{{ faq.system.handle }}" aria-expanded="false">
                      {{- faq.question.value -}}
                      <span class="animated-plus"></span>
                    </button>

                    <collapsible-content id="block-{{ section.id }}-{{ block.id }}-{{ faq.system.handle }}" class="collapsible anchor">
                      <div class="collapsible__content text-container">
                        {{- faq.response | metafield_tag -}}
                      </div>
                    </collapsible-content>
                  </div>
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
        {%- endcase -%}
      {%- endfor -%}
    </div>
  </div>

  {%- if section.settings.enable_schema -%}
    {%- capture questions_schema -%}
      {%- for block in section.blocks -%}
        {%- case block.type -%}

          {%- when 'question' -%}
            {
              "@type": "Question",
              "name": {{ block.settings.title | strip_html | replace: '"', "'" | json }},
              "acceptedAnswer": {
                "@type": "Answer",
                "text": {{ block.settings.answer | strip_html | replace: '"', "'" | json }}
              }
            },

          {%- when 'faq_collection' -%}
            {%- if block.settings.metaobject_handle != blank -%}
              {%- assign faq_collection = shop.metaobjects["faq_collection"][block.settings.metaobject_handle] -%}

              {%- if faq_collection != blank -%}
                {%- for faq in faq_collection.faqs.value -%}

                  {%- if faq.question.value == blank or faq.response.value == blank -%}
                    {%- continue -%}
                  {%- endif -%}

                  {
                    "@type": "Question",
                    "name": {{ faq.question.value | strip_html | replace: '"', "'" | json }},
                    "acceptedAnswer": {
                      "@type": "Answer",
                      "text": {{ faq.response | metafield_tag | strip_html | replace: '"', "'" | json  }}
                    }
                  },
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}

        {%- endcase -%}
      {%- endfor -%}
    {%- endcapture -%}

    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
          {{ questions_schema | remove_last: ","}}
        ]
      }
    </script>
  {%- endif -%}
{%- render 'section-end' -%}

{% schema %}
{
  "name": "FAQ",
  "class": "shopify-section--faq",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["header", "custom.overlay"]
  },
  "settings": [
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show navigation",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_schema",
      "label": "Show FAQ in Google search results",
      "default": false
    },
    {
      "type": "header",
      "content": "Section header"
    },
    {
      "type": "textarea",
      "id": "section_header_subheading",
      "label": "Subheading",
      "default": "Subheading"
    },
    {
      "type": "textarea",
      "id": "section_header_heading",
      "label": "Heading",
      "default": "Heading"
    },
    {
      "type": "richtext",
      "id": "section_header_short_description",
      "label": "Short description",
      "default": "<p>Your short description.</p>"
    },
    {
      "type": "select",
      "id": "section_header_heading_size",
      "label": "Heading size",
      "options": [
        {
          "value": "h1",
          "label": "Heading 1"
        },
        {
          "value": "h2",
          "label": "Heading 2"
        },
        {
          "value": "h3",
          "label": "Heading 3"
        },
        {
          "value": "h4",
          "label": "Heading 4"
        },
        {
          "value": "h5",
          "label": "Heading 5"
        },
        {
          "value": "h6",
          "label": "Heading 6"
        }
      ],
      "default": "h3"
    },
    {
      "type": "checkbox",
      "id": "section_header_highest_hierarchy",
      "label": "Highest hierarchy",
      "info": "Check this if this is the highest hierarchy heading on the page. This will make this a 'h1' heading, which should only be used once per page.",
      "default": false
    },
    {
      "type": "select",
      "id": "section_header_short_description_font_size",
      "label": "Short description font size",
      "options": [
        {
          "value": "xxsmall",
          "label": "Extra extra Small"
        },
        {
          "value": "xsmall",
          "label": "Extra Small"
        },
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ],
      "default": "medium"
    },
    {
      "type": "header",
      "content": "Section settings"
    },
    {
      "type": "select",
      "id": "section_container_width",
      "label": "Maximum width",
      "options": [
        {
          "value": "xxs",
          "label": "Extra extra Small"
        },
        {
          "value": "xs",
          "label": "Extra Small"
        },
        {
          "value": "sm",
          "label": "Small"
        },
        {
          "value": "md",
          "label": "Medium"
        },
        {
          "value": "fluid",
          "label": "Full width"
        }
      ],
      "default": "md"
    },
    {
      "type": "select",
      "id": "section_text_alignment",
      "label": "Text alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "left"
    },
    {
      "type": "color",
      "id": "section_background_color",
      "label": "Background color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "color",
      "id": "section_text_color",
      "label": "Text color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "color",
      "id": "section_heading_color",
      "label": "Heading color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "color",
      "id": "section_subheading_color",
      "label": "Subheading color",
      "default": "rgba(0,0,0,0)",
      "info": "Defaults to heading color."
    },
    {
      "type": "select",
      "id": "section_heading_font_family",
      "label": "Heading font",
      "options": [
        {
          "value": "default",
          "label": "Default"
        },
        {
          "value": "circular",
          "label": "Circular"
        },
        {
          "value": "publico",
          "label": "Publico"
        }
      ],
      "default": "default"
    },
    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "range",
      "id": "section_spacing_top",
      "label": "Top spacing",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 32
    },
    {
      "type": "range",
      "id": "section_spacing_bottom",
      "label": "Bottom spacing",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 32
    },
    {
      "type": "checkbox",
      "id": "section_spacing_different_mobile",
      "label": "Use different height on mobile",
      "default": false
    },
    {
      "type": "range",
      "id": "section_spacing_top_mobile",
      "label": "Top spacing (mobile)",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0
    },
    {
      "type": "range",
      "id": "section_spacing_bottom_mobile",
      "label": "Bottom spacing (mobile)",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "category",
      "name": "Category",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "Category"
        }
      ]
    },
    {
      "type": "question",
      "name": "Question",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Question",
          "default": "About your shop"
        },
        {
          "type": "richtext",
          "id": "answer",
          "label": "Answer",
          "default": "<p>Write content to help your customers to better understand your products or policies.</p>"
        }
      ]
    },
    {
      "type": "faq_collection",
      "name": "FAQ collection",
      "settings": [
        {
          "type": "text",
          "id": "metaobject_handle",
          "label": "Metaobject handle",
          "info": "Paste the handle of the metaobject. You can find the handle inside the FAQ collection metaobject."
        },
        {
          "type": "checkbox",
          "id": "show_title",
          "label": "Show category title",
          "default": true
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "FAQ",
      "blocks": [
        {
          "type": "category",
          "settings": {
            "title": "Shipping"
          }
        },
        {
          "type": "question",
          "settings": {
            "title": "Do you ship overseas?",
            "answer": "<p>Yes, we ship all over the world. Shipping costs will apply, and will be added at checkout. We run discounts and promotions all year, so stay tuned for exclusive deals.</p>"
          }
        },
        {
          "type": "question",
          "settings": {
            "title": "How long will it take to get my order?",
            "answer": "<p>It depends on where you are. Orders processed here will take 5-7 business days to arrive. Overseas deliveries can take anywhere from 7-16 days. Delivery details will be provided in your confirmation email.</p>"
          }
        },
        {
          "type": "category",
          "settings": {
            "title": "Other"
          }
        },
        {
          "type": "question",
          "settings": {
            "title": "Any question?",
            "answer": "<p>You can contact us through our contact page! We will be happy to assist you.</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
