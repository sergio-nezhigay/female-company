<style>
  #shopify-section-{{ section.id }} .discount-code-showcase {
    {%- if section.settings.inner_section_background == 'rgba(0,0,0,0)' -%}
      {%- assign inner_section_background = settings.section_background -%}
    {%- else -%}
      {%- assign inner_section_background = section.settings.inner_section_background -%}
    {%- endif -%}

    --image-border-radius: 50%;
    --discount-badge-text-color: {{ section.settings.discount_badge_text_color.red }}, {{ section.settings.discount_badge_text_color.green }}, {{ section.settings.discount_badge_text_color.blue }};
    --discount-badge-background: {{ section.settings.discount_badge_background.red }}, {{ section.settings.discount_badge_background.green }}, {{ section.settings.discount_badge_background.blue }};
    --inner-section-background: {{ inner_section_background.red }}, {{ inner_section_background.green }}, {{ inner_section_background.blue }};
    --inner-section-padding: 12px 16px;
  }
</style>

{%- liquid
  assign fixed_discount_code = section.settings.fixed_discount_code
  assign fixed_discount_amount = section.settings.fixed_discount_amount | strip
  assign url_discount_code = ''
  assign url_discount_amount = ''
  assign url_influencer_name = ''
  assign url_image_url = ''

  unless request.design_mode
    assign url_discount_code = url_params.discount_code | upcase
    assign url_discount_amount = url_params.discount_amount
    assign url_influencer_name = url_params.inf_name
    assign url_image_url = url_params.image_url
  endunless

  # Check if we have URL parameters
  if url_discount_code != blank
    assign is_fixed_code = false
    assign from_url = true
    assign discount_code = url_discount_code
    assign discount_amount = url_discount_amount
    assign influencer_name = url_influencer_name
    assign influencer_image = url_image_url
  else
    # No URL parameters, check fixed code
    if fixed_discount_code == 'NONE' or fixed_discount_code == blank
      if request.design_mode
        # Preview mode with no fixed code
        assign is_fixed_code = false
        assign from_url = false
        assign discount_code = 'DISCOUNT_CODE'
        assign discount_amount = '10%'
        assign influencer_name = 'influencername'
        assign influencer_image = 'influencer_placeholder.jpg'
      else
        # Hide section when no URL params and no fixed code
        assign is_fixed_code = false
        assign from_url = true
      endif
    else
      # Use fixed code
      assign is_fixed_code = true
      assign from_url = false
    endif
  endif
-%}

{%- render 'section' -%}
<div class="discount-code-showcase{% if is_fixed_code %} discount-code-showcase--fixed{% endif %}" style="{% if from_url and discount_code == blank %}display: none;{% endif %}" data-mode="{% if is_fixed_code %}fixed{% else %}url{% endif %}">
  <div
    class="discount-code-showcase__image"
    style="{% if is_fixed_code %}display: none;{% else %}{% if from_url == false and influencer_image == blank %}display: none;{% endif %}{% endif %}"
  >
    {%- unless from_url or is_fixed_code -%}
      <img
        src="{{ influencer_image | file_img_url: size: "75x75", crop: "center" }}"
        loading="lazy"
        width="75"
        height="75"
      >
    {%- endunless -%}
  </div>
  <div class="discount-code-showcase__content">
    {%- if is_fixed_code -%}
      <div class="discount-code-showcase__fixed-content">
        <p class="discount-code-showcase__text text--small">
          {{ 'sections.discount_code_showcase.text_with_amount' | t: discount_amount: fixed_discount_amount }}
        </p>
        <div class="discount-code-showcase__code">
          <button
            class="discount-code-showcase__code-button"
            type="button"
            data-code="{{ fixed_discount_code }}"
          >
            <span class="discount-code-showcase__code-text">
              {{ fixed_discount_code }}
            </span>
            <span class="text--xsmall text--muted">
              {%- render 'icons', name: 'far-clipboard' -%}
              {{ 'sections.discount_code_showcase.copy' | t }}
            </span>
          </button>
        </div>
      </div>
    {%- else -%}
      <h6 class="discount-code-showcase__heading heading h6">
        {%- unless from_url -%}
          @{{ influencer_name }}
          {% render 'icons', name: 'fas-badge-check', color: '#1e90fb' %}
        {%- endunless -%}
      </h6>
      <p class="discount-code-showcase__text text--small">
        {%- unless from_url -%}
          {{ 'sections.discount_code_showcase.text_with_amount' | t: discount_amount: discount_amount }}
        {%- endunless -%}
      </p>
      <div class="discount-code-showcase__code">
        <button
          class="discount-code-showcase__code-button"
          type="button"
          data-code="{{ discount_code }}"
        >
          <span class="discount-code-showcase__code-text">
            {{ discount_code }}
          </span>
          <span class="text--xsmall text--muted">
            {%- render 'icons', name: 'far-clipboard' -%}
            {{ 'sections.discount_code_showcase.copy' | t }}
          </span>
        </button>
      </div>
    {%- endif -%}
  </div>
</div>
{%- render 'section-end' -%}

<script>
  (function () {
    /**
     * Copy text to clipboard
     * @param {string} text
     */
    function copyTextToClipboard(text) {
      if (!navigator.clipboard) {
        var textArea = document.createElement('textarea');
        textArea.value = text;

        // Avoid scrolling to bottom
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.position = 'fixed';

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          const hasCopied = document.execCommand('copy');

          if (!hasCopied) {
            throw new Error('execCommand copy has returned false. Copy failed.');
          }

          document.body.removeChild(textArea);
          toastr.success("{{ 'sections.discount_code_showcase.copied_html' | t }}");
        } catch (e) {
          document.body.removeChild(textArea);
          toastr.success('An error occured. Please copy manually.');
        }

        return;
      } else {
        try {
          navigator.clipboard.writeText(text).then(
            function () {
              console.log('Async: Copying to clipboard was successful!');
            },
            function (e) {
              throw e;
            }
          );
          toastr.success("{{ 'sections.discount_code_showcase.copied_html' | t }}");
        } catch (e) {
          toastr.success('An error occured. Please copy manually.');
        }
      }
    }

    const sectionId = '#shopify-section-{{ section.id }}';
    const section = document.querySelector(sectionId);
    const discountCodeShowcase = section.querySelector('.discount-code-showcase');
    const isFixedCode = discountCodeShowcase.dataset.mode === 'fixed';

    const discountCodeShowcaseCodeButton = discountCodeShowcase.querySelector('.discount-code-showcase__code-button');
    discountCodeShowcaseCodeButton.addEventListener('click', function (e) {
      copyTextToClipboard(discountCodeShowcaseCodeButton.dataset.code);
    });

    if (!isFixedCode) {
      const urlParams = new URLSearchParams(window.location.search);
      const discountCode =
        typeof urlParams.get('discount_code') === 'string' ? urlParams.get('discount_code').toUpperCase() : null;
      const discountAmount = urlParams.get('discount_amount');
      const influencerName = urlParams.get('inf_name');
      const imageUrl = urlParams.get('image_url') ? urlParams.get('image_url') : null;

      if (discountCode) {
        discountCodeShowcase.querySelector('.discount-code-showcase__code-text').innerText = discountCode;
        discountCodeShowcase.querySelector('.discount-code-showcase__code-button').dataset.code = discountCode;

      if (imageUrl) {
        const imageWidth = 75;
        const imageHeight = 75;
        const image = document.createElement('img');
        image.width = imageWidth;
        image.height = imageHeight;
        const imageSrc = new URL(imageUrl);
        imageSrc.searchParams.set('width', imageWidth);
        imageSrc.searchParams.set('height', imageHeight);
        imageSrc.searchParams.set('crop', 'center');
        image.src = imageSrc;
        image.srcset = `${imageSrc} 1x`;

        const imageSrc2x = new URL(imageUrl);
        imageSrc2x.searchParams.set('width', imageWidth * 2);
        imageSrc2x.searchParams.set('height', imageHeight * 2);
        imageSrc2x.searchParams.set('crop', 'center');
        image.srcset += `, ${imageSrc2x} 2x`;

        const imageSrc3x = new URL(imageUrl);
        imageSrc3x.searchParams.set('width', imageWidth * 3);
        imageSrc3x.searchParams.set('height', imageHeight * 3);
        imageSrc3x.searchParams.set('crop', 'center');
        image.srcset += `, ${imageSrc3x} 3x`;

          image.alt = influencerName ?? '';
          section.querySelector('.discount-code-showcase__image').appendChild(image);
        } else {
          section.querySelector('.discount-code-showcase__image').style.display = 'none';
        }

        const discountText = discountAmount
          ? "{{ 'sections.discount_code_showcase.text_with_amount' | t }}".replace(
              '{% raw %}{{ discount_amount }}{% endraw %}',
              `${discountAmount}%`
            )
          : "{{ 'sections.discount_code_showcase.text' | t }}";

      if (influencerName) {
        const influencerLink = document.createElement('a');
        influencerLink.href = 'https://www.instagram.com/' + encodeURIComponent(influencerName);
        influencerLink.rel = 'nofollow';
        influencerLink.target = '_blank';
        influencerLink.innerText = '@' + influencerName;

        discountCodeShowcase.querySelector('.discount-code-showcase__heading').innerHTML = '';
        discountCodeShowcase.querySelector('.discount-code-showcase__heading').appendChild(influencerLink);
        discountCodeShowcase.querySelector('.discount-code-showcase__heading').innerHTML = `${
          discountCodeShowcase.querySelector('.discount-code-showcase__heading').innerHTML
        } {%- render 'icons', name: 'fas-badge-check', color: '#1e90fb' %}`;

        discountCodeShowcase.querySelector('.discount-code-showcase__text').innerText = discountText;
      } else {
        discountCodeShowcase.querySelector('.discount-code-showcase__heading').innerText = discountText;
      }

        discountCodeShowcase.removeAttribute('style');
      }
    }
  })();
</script>

{% stylesheet %}
  .discount-code-showcase {
    background: rgb(var(--inner-section-background));
    max-width: var(--inner-section-max-width);
    padding: var(--inner-section-padding);
    display: flex;
    align-items: center;
    margin: auto;
  }

  .discount-code-showcase--fixed {
    padding: 12px 16px;
    text-align: center;
    justify-content: center;
  }

  .discount-code-showcase--fixed .discount-code-showcase__content {
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
  }

  .discount-code-showcase--fixed .discount-code-showcase__fixed-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .discount-code-showcase--fixed .discount-code-showcase__text {
    margin: 0;
    font-size: 1em;
  }

  .discount-code-showcase--fixed .discount-code-showcase__code {
    margin: 0;
  }

  .discount-code-showcase__heading {
    margin-bottom: 2px;
  }

  .discount-code-showcase__text {
    margin: 0 0 0px 0;
  }

  .discount-code-showcase__image {
    width: 75px;
    height: 75px;
    border-radius: var(--image-border-radius);
    overflow: hidden;
    margin-right: 1rem;
  }

  .discount-code-showcase__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .discount-code-showcase__code-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 0;
    background: none;
    border: none;
    cursor: pointer;
  }

  .discount-code-showcase__code-text {
    display: inline-block;
    padding: 4px 8px;
    font-weight: bold;
    font-size: 1em;
    color: rgb(var(--discount-badge-text-color));
    background: rgb(var(--discount-badge-background));
    border-radius: 4px;
  }

  .discount-code-showcase__code-button:hover .discount-code-showcase__code-text {
    opacity: 0.9;
  }

  @media screen and (max-width: 749px) {
    .discount-code-showcase--fixed {
      padding: 8px 12px;
    }

    .discount-code-showcase--fixed .discount-code-showcase__text {
      font-size: 0.9em;
    }

    .discount-code-showcase__code-text {
      padding: 3px 6px;
      font-size: 0.9em;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Discount Code Showcase",
  "class": "shopify-section--discount-code-showcase",
  "settings": [
    {
      "type": "header",
      "content": "Fixed Discount Code"
    },
    {
      "type": "text",
      "id": "fixed_discount_code",
      "label": "Discount code",
      "default": "NONE",
      "info": "Enter the discount code to display. Set to NONE to use URL parameters."
    },
    {
      "type": "text",
      "id": "fixed_discount_amount",
      "label": "Discount amount",
      "default": "10%",
      "info": "Enter the discount amount (e.g. 10%)"
    },
    {
      "type": "header",
      "content": "URL Parameters"
    },
    {
      "type": "paragraph",
      "content": "This section can also take URL parameters to fill up its content: discount_code, discount_amount, inf_name, image_url. These will override the fixed discount code if present."
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "paragraph",
      "content": "This section takes the following URL parameters to fill up its content: discount_code, discount_amount, inf_name, image_url."
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "color",
      "id": "inner_section_background",
      "label": "Background of the inner element",
      "default": "#FFD9D9"
    },
    {
      "type": "color",
      "id": "discount_badge_background",
      "label": "Background of the discount badge",
      "default": "#EA697D"
    },
    {
      "type": "color",
      "id": "discount_badge_text_color",
      "label": "Text color of the discount badge",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Section settings"
    },
    {
      "type": "select",
      "id": "section_container_width",
      "label": "Maximum width",
      "options": [
        {
          "value": "xxs",
          "label": "Extra extra Small"
        },
        {
          "value": "xs",
          "label": "Extra Small"
        },
        {
          "value": "sm",
          "label": "Small"
        },
        {
          "value": "md",
          "label": "Medium"
        },
        {
          "value": "fluid",
          "label": "Full width"
        }
      ],
      "default": "xxs"
    },
    {
      "type": "color",
      "id": "section_background_color",
      "label": "Background color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "color",
      "id": "section_text_color",
      "label": "Text color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "color",
      "id": "section_heading_color",
      "label": "Heading color",
      "default": "rgba(0,0,0,0)"
    },
    {
      "type": "header",
      "content": "Section settings"
    },
    {
      "type": "range",
      "id": "section_spacing_top",
      "label": "Top spacing",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 32
    },
    {
      "type": "range",
      "id": "section_spacing_bottom",
      "label": "Bottom spacing",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 32
    },
    {
      "type": "checkbox",
      "id": "section_spacing_different_mobile",
      "label": "Use different height on mobile",
      "default": false
    },
    {
      "type": "range",
      "id": "section_spacing_top_mobile",
      "label": "Top spacing (mobile)",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0
    },
    {
      "type": "range",
      "id": "section_spacing_bottom_mobile",
      "label": "Bottom spacing (mobile)",
      "unit": "px",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Discount Code Showcase",
      "category": "Custom"
    }
  ]
}
{% endschema %}
