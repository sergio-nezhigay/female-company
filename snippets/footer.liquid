{%- comment -%}Linkster - відкладене завантаження{%- endcomment -%}
{% if request.locale.iso_code == 'nl'%}
  {%- assign linkster_campaign_id = '411' -%}
{% else %}
  {%- assign linkster_campaign_id = '239' -%}
{% endif %}

<script>
  (function() {
    function loadLinkster() {
      if (window.linksterLoaded) return;
      window.linksterLoaded = true;

      var script = document.createElement('script');
      script.defer = true;
      script.type = 'text/plain';
      script.setAttribute('data-usercentrics', 'Linkster');
      script.src = 'https://trck.linkster.co/trck/etms/eatms.js?campaign_id={{ linkster_campaign_id }}';
      document.body.appendChild(script);
    }

    {%- comment -%}Завантаження на idle{%- endcomment -%}
    if ('requestIdleCallback' in window) {
      requestIdleCallback(loadLinkster, { timeout: 12000 });
    } else {
      setTimeout(loadLinkster, 12000);
    }
  })();
</script>


{%- comment -%}Klaviyo - відкладене завантаження після взаємодії{%- endcomment -%}
{%- if request.page_type != 'product' -%}
  <script>
    (function() {
      function loadKlaviyo() {
        if (window.klaviyoLoaded) return;
        window.klaviyoLoaded = true;
        
        var scripts = [
          '//www.klaviyo.com/media/js/public/klaviyo_subscribe.js',
          'https://a.klaviyo.com/media/js/onsite/onsite.js',
          '{{ "klaviyo-custom.js" | asset_url }}'
        ];
        
        scripts.forEach(function(src) {
          var s = document.createElement('script');
          s.src = src;
          s.defer = true;
          s.setAttribute('type', 'text/plain');
          s.setAttribute('data-usercentrics', 'Klaviyo');
          document.body.appendChild(s);
        });
      }

      // Завантаження після першої взаємодії або через 5 секунд
      var events = ['scroll', 'mousemove', 'touchstart', 'keydown'];
      var timeout = setTimeout(loadKlaviyo, 5000);
      
      events.forEach(function(event) {
        window.addEventListener(event, function() {
          clearTimeout(timeout);
          loadKlaviyo();
        }, { once: true, passive: true });
      });
    })();
  </script>
{%- endif -%}

{%- comment -%}Trustpilot - відкладене завантаження на idle{%- endcomment -%}
<script>
  (function() {
    function loadTrustpilot() {
      if (window.trustpilotLoaded) return;
      window.trustpilotLoaded = true;

      var script = document.createElement('script');
      script.defer = true;
      script.type = 'text/plain';
      script.setAttribute('data-usercentrics', 'Trustpilot');
      script.src = 'https://widget.trustpilot.com/bootstrap/v5/tp.widget.bootstrap.min.js';
      document.body.appendChild(script);
    }

    {%- comment -%}Завантаження на idle або через 10 секунд{%- endcomment -%}
    if ('requestIdleCallback' in window) {
      requestIdleCallback(loadTrustpilot, { timeout: 10000 });
    } else {
      setTimeout(loadTrustpilot, 10000);
    }
  })();
</script>

<!-- Reviews.io -->
<script>
  function renderReviewsIoWidgets() {
    if(typeof ratingSnippet !== 'undefined') {
      ratingSnippet("reviewsio_rating-stars--micro", {
        store: reviewsIoStore,
        mode: "minimal",
        color: '#f58e9e',
        textClr: '#1a1a1a',
        linebreak: false,
        usePolaris: true,
        removeBrackets: true,
        text: 'Bewertungen',
        singularText: "Bewertung",
        lang: reviewsIoLang,
        showEmptyStars: false
      });

      ratingSnippet("reviewsio_rating-stars--full", {
        store: reviewsIoStore,
        mode: "default",
        color: '#f58e9e',
        textClr: '#1a1a1a',
        linebreak: false,
        usePolaris: true,
        removeBrackets: true,
        text: 'Bewertungen',
        singularText: "Bewertung",
        lang: reviewsIoLang,
        showEmptyStars: false
      });
    }
  }

  window.addEventListener('DOMContentLoaded', renderReviewsIoWidgets);
  window.addEventListener('product-facet:rerender', renderReviewsIoWidgets);
</script>

{%- comment -%}LinkedIn Insight Tag тепер завантажується через optimized-analytics.liquid{%- endcomment -%}
