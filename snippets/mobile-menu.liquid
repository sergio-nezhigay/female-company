{%- assign direction = 'ltr' -%}
{%- case request.locale.iso_code -%}
  {%- when 'ar' or 'arc' or 'dv' or 'fa' or 'ha' or 'he' or 'kwh' or 'ks' or 'ku' or 'ps' or 'ur' or 'yi' -%}
    {%- assign direction = 'rtl' -%}
{%- endcase -%}

{%- assign current_locale = request.locale.iso_code -%}

{%- assign absorbancy_original = 'Light,Medium,Extra+Strong,Ultra+Strong' | split: ',' -%}
{%- assign absorbancy_en = 'Light,Medium,Extra+Strong,Ultra+Strong' | split: ',' -%}
{%- assign absorbancy_nl = 'Light,Medium,Extra+Strong,Ultra+Strong' | split: ',' -%}
{%- assign absorbancy_de = 'Light,Medium,Extra+Strong,Ultra+Strong' | split: ',' -%}

{%- assign style_original = 'Slip,Brief,Tanga,Brazilian,High+Waist,Hipster' | split: ',' -%}
{%- assign style_en = 'Slip,Brief,Thong,Brazilian,High+Waist,Hipster' | split: ',' -%}
{%- assign style_nl = 'Slip,Brief,Tanga,Brazilian,Hoge+taille,Hipster' | split: ',' -%}
{%- assign style_de = 'Slip,Brief,Tanga,Brazilian,Hoch+tailliert,Hipster' | split: ',' -%}

<mobile-navigation append-body id="mobile-menu-drawer" class="drawer {% if direction == 'ltr' %}drawer--from-left{% endif %}">
  <span class="drawer__overlay"></span>

  <div class="drawer__header drawer__header--shadowed">
    <button type="button" class="drawer__close-button drawer__close-button--block tap-area" data-action="close" title="{{ 'general.accessibility.close' | t | escape }}">
      {%- render 'icon' with 'close' -%}
    </button>
  </div>

  <div class="drawer__content">
    <ul class="mobile-nav list--unstyled" role="list">
      {%- for link in menu.links -%}
        {%- assign link_title_downcase = link.title | strip | downcase -%}
        {%- assign mega_menu_block = '' -%}
        {%- assign mega_menu_images = '' -%}

        {%- for block in section.blocks -%}
          {%- assign menu_item_downcase = block.settings.menu_item | strip | downcase -%}

          {%- if menu_item_downcase == link_title_downcase -%}
            {%- assign mega_menu_block = block -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if mega_menu_block != '' -%}
          {%- assign images_count = 0 -%}

          {%- capture mega_menu_images -%}
            {%- for i in (1..6) -%}
              {%- capture image_setting -%}image_{{ i }}{%- endcapture -%}

              {%- if mega_menu_block.settings[image_setting] != blank -%}
                {%- assign images_count = images_count | plus: 1 -%}

                {%- capture image_heading_setting -%}image_{{ i }}_heading{%- endcapture -%}
                {%- capture image_text_setting -%}image_{{ i }}_text{%- endcapture -%}
                {%- capture image_link_setting -%}image_{{ i }}_link{%- endcapture -%}

                {%- capture image_push -%}
                  {%- assign menu_image = mega_menu_block.settings[image_setting] -%}
                  {{- menu_image | image_url: width: menu_image.width | image_tag: loading: 'lazy', sizes: '270px', sizes: '270,540,810', class: 'mobile-nav__image' -}}

                  {%- if mega_menu_block.settings[image_heading_setting] != '' -%}
                    <p class="mobile-nav__image-heading heading heading--xsmall">{{ mega_menu_block.settings[image_heading_setting] }}</p>
                  {%- endif -%}

                  {%- if mega_menu_block.settings[image_text_setting] != '' -%}
                    <span class="mobile-nav__image-text text--xsmall">{{ mega_menu_block.settings[image_text_setting] }}</span>
                  {%- endif -%}
                {%- endcapture -%}

                {%- if mega_menu_block.settings[image_link_setting] != blank -%}
                  <a href="{{ mega_menu_block.settings[image_link_setting] }}" class="mobile-nav__image-push">
                    {{- image_push -}}
                  </a>
                {%- else -%}
                  <div class="mobile-nav__image-push">
                    {{- image_push -}}
                  </div>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endcapture -%}
        {%- endif -%}

        <li class="mobile-nav__item" data-level="1">
          {%- assign link_icon_handle = '' -%}
          {%- assign link_badge_content = '' -%}
          {%- assign link_title = link.title -%}

          {%- if link.title contains '%%' -%}
            {%- assign link_icon_handle = link.title | split: '%%' | first | strip -%}
            {%- assign link_title = link.title | split: '%%' | last -%}
          {%- endif -%}

          {%- if link_title contains '$$' -%}
            {%- assign link_badge_content = link_title | split: '$$' | first | strip -%}
            {%- assign link_title = link_title | split: '$$' | last -%}
          {%- endif -%}

          {%- if link.links.size > 0 or mega_menu_images != blank -%}
            <button
              is="toggle-button"
              class="mobile-nav__link heading {% if settings.heading_text_transform == 'uppercase' %}h6{% else %}h6{% endif %} {% if link_icon_handle != blank %}link--with-icon{% endif %}"
              aria-controls="mobile-menu-{{ forloop.index }}"
              aria-expanded="false"
            >
              {%- if link_icon_handle != blank -%}
                {%- render 'icon', icon: link_icon_handle -%}
              {%- endif -%}

              {% if link_badge_content == blank %}
                <span class="mobile-nav__link-text">
                  {{ link_title }}
                </span>
              {%  else %}
                <span class="mobile-nav__link-text">
                  {{ link_title }}
                  <span class="mobile-nav__link-badge">{{ link_badge_content }}</span>
                </span>
              {% endif %}

              <span class="animated-plus"></span>
            </button>

            <collapsible-content id="mobile-menu-{{ forloop.index }}" class="collapsible">
              {%- if link.links.size > 0 -%}
                <ul class="mobile-nav list--unstyled" role="list">
                  {%- for sub_link in link.links -%}
                    <li class="mobile-nav__item" data-level="2">
                      {%- assign sub_link_icon_handle = '' -%}
                      {%- assign sub_link_title       = sub_link.title -%}

                      {%- if sub_link.title contains '%%' -%}
                        {%- assign sub_link_icon_handle = sub_link.title | split: '%%' | first | strip -%}
                        {%- assign sub_link_title       = sub_link.title | split: '%%' | last -%}
                      {%- endif -%}

                      {%- if sub_link.links.size > 0 -%}

                      <button
                        is="toggle-button"
                        class="mobile-nav__link {% if sub_link_icon_handle != blank %}link--with-icon{% endif %}"
                        aria-controls="mobile-menu-{{ forloop.parentloop.index }}-{{ forloop.index }}"
                        aria-expanded="false"
                      >
                        {%- if sub_link_icon_handle != blank -%}
                          {%- render 'icon', icon: sub_link_icon_handle -%}
                        {%- endif -%}

                        <span class="mobile-nav__link-text">
                          {{- sub_link_title -}}
                        </span>

                        <span class="animated-plus"></span>
                      </button>

                        <collapsible-content id="mobile-menu-{{ forloop.parentloop.index }}-{{ forloop.index }}" class="collapsible">
                          <ul class="mobile-nav list--unstyled" role="list">
                            {%- for sub_sub_link in sub_link.links -%}
                              <li class="mobile-nav__item" data-level="3">
                                {%- assign sub_sub_link_icon_handle = '' -%}
                                {%- assign sub_sub_link_title       = sub_sub_link.title -%}

                                {%- if sub_link.title contains '%%' -%}
                                  {%- assign sub_sub_link_icon_handle = sub_sub_link.title | split: '%%' | first | strip -%}
                                  {%- assign sub_sub_link_title       = sub_sub_link.title | split: '%%' | last -%}
                                {%- endif -%}

                                {%- if sub_sub_link.url contains 'collections' -%}
                                  {%- assign menu_url = sub_sub_link.url -%}
                                  {%- if menu_url contains 'filter.p.m.filters.absorbancy=' -%}
                                    {%- assign parts = menu_url | split: 'filter.p.m.filters.absorbancy=' -%}
                                    {%- assign after_filter = parts[1] | split: '&' | first -%}
                                    {%- assign translated_value = '' -%}
                                    
                                    {%- for original in absorbancy_original -%}
                                      {%- if original == after_filter -%}
                                        {%- assign index = forloop.index0 -%}
                                        {%- case current_locale -%}
                                          {%- when 'en' -%}
                                            {%- assign translated_value = absorbancy_en[index] -%}
                                          {%- when 'nl' -%}
                                            {%- assign translated_value = absorbancy_nl[index] -%}
                                          {%- when 'de' -%}
                                            {%- assign translated_value = absorbancy_de[index] -%}
                                          {%- when 'ar' -%}
                                            {%- assign translated_value = absorbancy_ar[index] -%}
                                        {%- endcase -%}
                                        
                                        {%- if translated_value != '' -%}
                                          {%- assign menu_url = menu_url | replace: after_filter, translated_value | replace: ' ', '+' -%}
                                        {%- endif -%}
                                      {%- endif -%}
                                    {%- endfor -%}
                                  {%- endif -%}

                                  {%- if menu_url contains 'filter.p.m.filters.style=' -%}
                                    {%- assign parts = menu_url | split: 'filter.p.m.filters.style=' -%}
                                    {%- assign after_filter = parts[1] | split: '&' | first -%}
                                    {%- assign translated_value = '' -%}
                                    
                                    {%- for original in style_original -%}
                                      {%- if original == after_filter -%}
                                        {%- assign index = forloop.index0 -%}
                                        {%- case current_locale -%}
                                          {%- when 'en' -%}
                                            {%- assign translated_value = style_en[index] -%}
                                          {%- when 'nl' -%}
                                            {%- assign translated_value = style_nl[index] -%}
                                          {%- when 'de' -%}
                                            {%- assign translated_value = style_de[index] -%}
                                        {%- endcase -%}
                                        
                                        {%- if translated_value != '' -%}
                                          {%- assign menu_url = menu_url | replace: after_filter, translated_value | replace: ' ', '+' -%}
                                        {%- endif -%}
                                      {%- endif -%}
                                    {%- endfor -%}
                                  {%- endif -%}
                                  
                                  <a href="https://{{ shop.domain }}{{ locale_prefix }}{{ menu_url | split: shop.domain | last }}" class="mobile-nav__link {% if sub_sub_link_icon_handle != blank %}link--with-icon{% endif %}">
                                {%- else -%}
                                  <a href="{{ sub_sub_link.url }}" class="mobile-nav__link {% if sub_sub_link_icon_handle != blank %}link--with-icon{% endif %}">
                                {%- endif -%}
                                  {%- if sub_sub_link_icon_handle != blank -%}
                                    {%- render 'icon', icon: sub_sub_link_icon_handle -%}
                                  {%- endif -%}

                                  <span class="mobile-nav__link-text">
                                    {{- sub_sub_link_title -}}
                                  </span>
                                </a>
                              </li>
                            {%- endfor -%}
                          </ul>
                        </collapsible-content>
                      {%- else -%}
                        <a href="{{ sub_link.url }}" class="mobile-nav__link {% if sub_link_icon_handle != blank %}link--with-icon{% endif %}">
                          {%- if sub_link_icon_handle != blank -%}
                            {%- render 'icon', icon: sub_link_icon_handle -%}
                          {%- endif -%}

                          <span class="mobile-nav__link-text">
                            {{- sub_link_title -}}
                          </span>
                        </a>
                      {%- endif -%}
                    </li>
                  {%- endfor -%}
                </ul>
              {%- endif -%}

              {%- if mega_menu_images != blank -%}
                <div class="mobile-nav__images-wrapper {% if images_count >= 3 %}mobile-nav__images-wrapper--tight{% endif %} hide-scrollbar">
                  <div class="mobile-nav__images-scroller">
                    {{- mega_menu_images -}}
                  </div>
                </div>
              {%- endif -%}
            </collapsible-content>
          {%- else -%}
            <a
              href="{{ link.url }}"
              class="mobile-nav__link heading {% if settings.heading_text_transform == 'uppercase' %}h6{% else %}h6{% endif %} {% if link_icon_handle != blank %}link--with-icon{% endif %}"
            >
              {%- if link_icon_handle != blank -%}
                {%- render 'icon', icon: link_icon_handle -%}
              {%- endif -%}

              {% if link_badge_content == blank %}
                <span class="mobile-nav__link-text">
                  {{ link_title }}
                </span>
              {%  else %}
                <span class="mobile-nav__link-text">
                  {{ link_title }}
                  <span class="mobile-nav__link-badge">
                    {{ link_badge_content }}
                  </span>
                </span>
              {% endif %}

            </a>
          {%- endif -%}
        </li>
      {%- endfor -%}
    </ul>
  </div>

  {%- if section.settings.show_locale_selector and shop.published_locales.size > 1 -%}
    {%- assign locale_selector = true -%}
  {%- endif -%}

  {%- if section.settings.show_country_selector and localization.available_countries.size > 1 -%}
    {%- assign country_selector = true -%}
  {%- endif -%}

  {%- if shop.customer_accounts_enabled or locale_selector or country_selector -%}
    <div class="drawer__footer drawer__footer--tight drawer__footer--bordered">
      <div class="mobile-nav__footer">
        {%- if shop.customer_accounts_enabled -%}
          <a class="icon-text" href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}">
            {%- render 'icon' with 'header-customer' -%}
            {{- 'header.general.account' | t -}}
          </a>
        {%- endif -%}

        {%- if locale_selector or country_selector -%}
          {%- form 'localization', id: 'header-sidebar-localization-form', class: 'header__cross-border' -%}
            {%- if country_selector -%}
              <div class="popover-container">
                <input type="hidden" name="country_code" value="{{ localization.country.iso_code }}">
                <span class="visually-hidden">{{ 'header.general.country' | t }}</span>

                <button type="button" is="toggle-button" class="popover-button text--xsmall tap-area" aria-expanded="false" aria-controls="header-sidebar-localization-form-currency">
                  {{- localization.country.name }} ({{ localization.country.currency.iso_code }} {% if localization.country.currency.symbol %}{{ localization.country.currency.symbol }}{%- endif -%})
                  {%- render 'icon' with 'chevron', width: 9, height: 6, inline: true -%}
                </button>

                <popover-content id="header-sidebar-localization-form-currency" class="popover popover--top popover--small">
                  <span class="popover__overlay"></span>

                  <header class="popover__header">
                    <span class="popover__title heading h6">{{- 'header.general.country' | t -}}</span>

                    <button type="button" class="popover__close-button tap-area tap-area--large" data-action="close" title="{{ 'general.accessibility.close' | t | escape }}">
                      {%- render 'icon' with 'close' -%}
                    </button>
                  </header>

                  <div class="popover__content">
                    <div class="popover__choice-list">
                      {%- for country in localization.available_countries -%}
                        <button type="submit" name="country_code" value="{{ country.iso_code }}" class="popover__choice-item">
                          <span class="popover__choice-label" {% if country.iso_code == localization.country.iso_code %}aria-current="true"{% endif %}>
                            {{- country.name }} ({{ country.currency.iso_code }} {% if country.currency.symbol %}{{ country.currency.symbol }}{%- endif -%})
                          </span>
                        </button>
                      {%- endfor -%}
                    </div>
                  </div>
                </popover-content>
              </div>
            {%- endif -%}

            {%- if locale_selector -%}
              <div class="popover-container">
                <input type="hidden" name="locale_code" value="{{ form.current_locale.iso_code }}">
                <span class="visually-hidden">{{ 'header.general.language' | t }}</span>

                <button type="button" is="toggle-button" class="popover-button text--xsmall tap-area" aria-expanded="false" aria-controls="header-sidebar-localization-form-locale">
                  {%- if show_flag == true -%}
                    {% render "icons", name: form.current_locale.iso_code, class: "popover-flag" %}
                  {%- endif -%}

                  {{- form.current_locale.endonym_name | capitalize -}}
                  {%- render 'icon' with 'chevron', width: 9, height: 6, inline: true -%}
                </button>

                <popover-content id="header-sidebar-localization-form-locale" class="popover popover--top popover--small">
                  <span class="popover__overlay"></span>

                  <header class="popover__header">
                    <span class="popover__title heading h6">{{- 'header.general.language' | t -}}</span>

                    <button type="button" class="popover__close-button tap-area tap-area--large" data-action="close" title="{{ 'general.accessibility.close' | t | escape }}">
                      {%- render 'icon' with 'close' -%}
                    </button>
                  </header>

                  <div class="popover__content">
                    <div class="popover__choice-list">
                      {%- for locale in form.available_locales -%}
                        <button type="submit" name="locale_code" value="{{ locale.iso_code }}" class="popover__choice-item language-switch">
                          <span class="popover__choice-label" {% if locale.iso_code == form.current_locale.iso_code %}aria-current="true"{% endif %}>
                            {%- if show_flag == true -%}
                              {% render "icons", name: locale.iso_code, class: "popover-flag" %}
                            {%- endif -%}

                            {{- locale.endonym_name | capitalize -}}
                          </span>
                        </button>
                      {%- endfor -%}
                    </div>
                  </div>
                </popover-content>
              </div>
            {%- endif -%}
          {%- endform -%}
        {%- endif -%}
      </div>
    </div>
  {%- endif -%}
</mobile-navigation>
